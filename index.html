<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Welcome Booklet</title>
    <style>
        /* Paste your CSS here, or use your existing CSS unchanged */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: transparent !important; }
        #overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(20, 20, 20, 0.63); display: none; z-index: 9999; }
        #booklet { width: 560px; margin: 60px auto 0 auto; background: rgba(28, 29, 41, 0.74); border-radius: 24px; box-shadow: 0 8px 40px #0088ff33; animation: fadeIn 0.7s; overflow: hidden; position: relative; top: 100px; border: 2px solid #00447e; }
        .header, .info-header { display: flex; align-items: center; justify-content: space-between; padding: 32px 28px 0 28px; }
        .icon { width: 56px; border-radius: 16px; margin-right: 20px; border: 2px solid #0088ff; }
        .header h1, .info-header h2 { flex: 1; color: #0088ff; font-size: 2.1em; margin: 0; text-align: left; text-shadow: 0 2px 8px #00447e33; letter-spacing: 0.02em; }
        .close { background: none; border: none; font-size: 2em; color: #0088ff; cursor: pointer; transition: color 0.2s; }
        .close:hover { color: #fff; }
        .back { background: none; border: none; font-size: 1.7em; color: #0088ff; margin-right: 20px; cursor: pointer; transition: color 0.2s; }
        .back:hover { color: #fff; }
        .desc { text-align: center; color: #6ec1ff; margin-bottom: 18px; font-size: 1.12em; }
        .locations { display: grid; grid-template-columns: repeat(2, 1fr); gap: 28px 24px; margin: 20px 28px 38px 28px; }
        .location { background: #222e39; border-radius: 20px; box-shadow: 0 2px 16px #00447e30; display: flex; align-items: center; padding: 18px; cursor: pointer; transition: transform 0.13s, box-shadow 0.13s, border 0.13s; border: 2px solid #00447e; }
        .location img { width: 44px; height: 44px; border-radius: 12px; margin-right: 18px; border: 2px solid #0088ff; background: #141414; }
        .location span { font-size: 1.2em; color: #6ec1ff; font-weight: 500; }
        .location:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 6px 30px #0088ff55; border: 2px solid #0088ff; background: #003860; }
        #jobcenter-page, #activities-page { display: none; }
        .joblist, .activitylist { display: grid; grid-template-columns: 1fr 1fr; gap: 18px 18px; margin: 30px 38px 34px 38px; }
        .job, .activity { background: #222e39; border-radius: 16px; box-shadow: 0 2px 12px #00447e30; display: flex; align-items: center; padding: 16px; cursor: pointer; border: 2px solid #00447e; transition: transform 0.13s, box-shadow 0.13s, border 0.13s; }
        .job:hover, .activity:hover { transform: scale(1.04); border: 2px solid #0088ff; background: #003860; }
        .job img, .activity img { width: 36px; height: 36px; border-radius: 9px; margin-right: 18px; border: 2px solid #0088ff; background: #141414; }
        .job span, .activity span { font-size: 1.1em; color: #6ec1ff; font-weight: 500; }
        #info-page { position: relative; min-height: 340px; padding-bottom: 36px; }
        .info-header { position: relative; z-index: 2; padding-top: 28px; padding-bottom: 8px; }
        .info-bg { width: 100%; height: 180px; background-size: cover; background-position: center; border-radius: 0 0 30px 30px; margin-bottom: 8px; position: relative; z-index: 1; filter: brightness(0.82) saturate(1.15); border-bottom: 2px solid #0088ff; }
        .info-content { position: relative; z-index: 2; background: rgba(20,20,20,0.93); margin: -26px 34px 0 34px; border-radius: 16px; padding: 6px 20px 22px 20px; box-shadow: 0 4px 18px #0088ff22; display: flex; flex-direction: column; align-items: center; }
        #info-desc { color: #6ec1ff; font-size: 1.07em; margin-bottom: 22px; text-align: center; min-height: 52px; font-weight: 400; }
        .setwp-btn { padding: 12px 28px; background: linear-gradient(90deg,#0088ff,#00447e 90%); color: #fff; border: none; border-radius: 10px; font-size: 1.11em; box-shadow: 0 2px 10px #0088ff33; cursor: pointer; transition: background 0.14s, transform 0.14s; margin-top: 8px; font-weight: 500; }
        .setwp-btn:hover { background: linear-gradient(90deg,#00447e,#0088ff 90%); transform: scale(1.05); }
        ul { margin: 0 0 8px 0; }
        li { color: #8ccaff; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        .fade-in { animation: fadeIn 0.5s; }
    </style>
</head>
<body>
<div id="overlay">
    <div id="booklet" class="fade-in">
        <div id="main-page">
            <div class="header">
                <img src="img/elysian.png" alt="Booklet" class="icon">
                <h1>Welcome to Elysian City</h1>
                <button class="close" onclick="closeBooklet()">×</button>
            </div>
            <p class="desc">Click something to learn more about it!</p>
            <div class="locations" id="main-locations"></div>
        </div>
        <div id="jobcenter-page" style="display:none;">
            <div class="info-header">
                <button class="back" onclick="showMain()">&larr;</button>
                <h2>Job Center</h2>
                <button class="close" onclick="closeBooklet()">×</button>
            </div>
            <div id="jobcenter-bg" class="info-bg" style="background-image:url('img/jobcenter.jpg')"></div>
            <div class="info-content">
                <p id="jobcenter-desc" style="color:#8ccaff;">Here's some jobs available around the city. Click one to learn more!</p>
                <div class="joblist" id="job-list"></div>
            </div>
        </div>
        <div id="activities-page" style="display:none;">
            <div class="info-header">
                <button class="back" onclick="showMain()">&larr;</button>
                <h2>Activities</h2>
                <button class="close" onclick="closeBooklet()">×</button>
            </div>
            <div id="activities-bg" class="info-bg" style="background-image:url('img/bgactive.jpg')"></div>
            <div class="info-content">
                <p style="color:#8ccaff;">Here's some activities to check out around the city!</p>
                <div class="activitylist" id="activity-list"></div>
            </div>
        </div>
        <div id="info-page" style="display:none;">
            <div class="info-header">
                <button class="back" id="info-back-btn" onclick="showMain()">&larr;</button>
                <h2 id="info-title"></h2>
                <button class="close" onclick="closeBooklet()">×</button>
            </div>
            <div id="info-bg" class="info-bg"></div>
            <div class="info-content">
                <p id="info-desc"></p>
                <button id="setwp-btn" class="setwp-btn">Set Waypoint</button>
            </div>
        </div>
    </div>
</div>
<div id="alert" style="display:none;position:fixed;top:12%;left:50%;transform:translate(-50%,0);background:#0088ff;color:#fff;padding:16px 32px;border-radius:16px;font-size:1.2em;box-shadow:0 2px 16px #0002;z-index:10000;">Waypoint set!</div>
<script>
let mainMenuLinks = [], jobInfoData, activityInfoData;

window.addEventListener('message', function (event) {
    if (event.data && event.data.action === 'open') {
        document.getElementById('overlay').style.display = 'block';
        fetch(`https://${GetParentResourceName()}/fetchConfig`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(res => res.json())
        .then(cfg => {
            mainMenuLinks = cfg.MainMenu || [];
            jobInfoData = cfg.Jobs;
            activityInfoData = cfg.Activities;
            renderMainLinks();
            renderJobList();
            renderActivityList();
            showMain();
        });
    }
});

function renderMainLinks() {
    const main = document.getElementById('main-locations');
    main.innerHTML = '';
    mainMenuLinks.forEach(link => {
        let onclick = '';
        if (link.type === 'jobcenter') {
            onclick = "openJobcenter()";
        } else if (link.type === 'activities') {
            onclick = "openActivities()";
        } else if (link.type === 'info') {
            onclick = `openInfo('${link.key}')`;
        }
        main.innerHTML += `
            <div class="location" onclick="${onclick}">
                <img src="${link.icon}">
                <span>${link.label}</span>
            </div>
        `;
    });
}

function renderJobList() {
    const list = document.getElementById('job-list');
    if (!jobInfoData) return;
    list.innerHTML = '';
    Object.keys(jobInfoData).forEach(jobKey => {
        const job = jobInfoData[jobKey];
        list.innerHTML += `
            <div class="job" onclick="openJobInfo('${jobKey}')">
                <img src="${job.icon || 'img/job_default.png'}">
                <span>${job.title}</span>
            </div>
        `;
    });
}

function renderActivityList() {
    const list = document.getElementById('activity-list');
    if (!activityInfoData) return;
    list.innerHTML = '';
    Object.keys(activityInfoData).forEach(actKey => {
        const act = activityInfoData[actKey];
        list.innerHTML += `
            <div class="activity" onclick="openActivityInfo('${actKey}')">
                <img src="${act.icon || 'img/activity_default.png'}">
                <span>${act.title}</span>
            </div>
        `;
    });
}

function closeBooklet() {
    document.getElementById('overlay').style.display = 'none';
    fetch(`https://${GetParentResourceName()}/close`, { method: 'POST' });
}

function openInfo(key) {
    const link = mainMenuLinks.find(l => l.key === key);
    let backBtn = document.getElementById('info-back-btn');
    if (!link) return;
    backBtn.onclick = showMain;
    document.getElementById('main-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'block';
    document.getElementById('info-title').innerText = link.label || link.title;
    document.getElementById('info-desc').innerHTML = link.desc || "";
    document.getElementById('info-bg').style.backgroundImage = link.bg ? `url('${link.bg}')` : "";

    // Show waypoint if coords exist
    const btn = document.getElementById('setwp-btn');
    if (link.coords) {
        btn.style.display = 'inline-block';
        btn.onclick = null;
        btn.onclick = () => setWaypoint(link.coords);
    } else {
        btn.style.display = 'none';
    }
}

function openJobcenter() {
    document.getElementById('main-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'block';
}
function openActivities() {
    document.getElementById('main-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'block';
}
function showMain() {
    document.getElementById('main-page').style.display = 'block';
    document.getElementById('info-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'none';
}
function showJobcenter() {
    document.getElementById('main-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'block';
}
function showActivities() {
    document.getElementById('main-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'block';
}
function openJobInfo(jobKey) {
    const job = jobInfoData[jobKey];
    let backBtn = document.getElementById('info-back-btn');
    if (!job) return;
    backBtn.onclick = showJobcenter;
    document.getElementById('main-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'block';
    document.getElementById('info-title').innerText = job.title;
    document.getElementById('info-desc').innerHTML = job.desc;
    document.getElementById('info-bg').style.backgroundImage = job.bg ? `url('${job.bg}')` : "";
    const btn = document.getElementById('setwp-btn');
    if (job.coords) {
        btn.style.display = 'inline-block';
        btn.onclick = null;
        btn.onclick = () => setWaypoint(job.coords);
    } else {
        btn.style.display = 'none';
    }
}
function openActivityInfo(activityKey) {
    const act = activityInfoData[activityKey];
    let backBtn = document.getElementById('info-back-btn');
    if (!act) return;
    backBtn.onclick = showActivities;
    document.getElementById('main-page').style.display = 'none';
    document.getElementById('jobcenter-page').style.display = 'none';
    document.getElementById('activities-page').style.display = 'none';
    document.getElementById('info-page').style.display = 'block';
    document.getElementById('info-title').innerText = act.title;
    document.getElementById('info-desc').innerHTML = act.desc;
    document.getElementById('info-bg').style.backgroundImage = act.bg ? `url('${act.bg}')` : "";
    const btn = document.getElementById('setwp-btn');
    if (act.coords) {
        btn.style.display = 'inline-block';
        btn.onclick = null;
        btn.onclick = () => setWaypoint(act.coords);
    } else {
        btn.style.display = 'none';
    }
}
function setWaypoint(coords) {
    if (coords) {
        fetch(`https://${GetParentResourceName()}/setWaypoint`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ coords: coords })
        });
        showAlertAndClose();
    }
}
function showAlertAndClose() {
    const alertDiv = document.getElementById('alert');
    alertDiv.style.display = 'block';
    setTimeout(() => {
        alertDiv.style.display = 'none';
        closeBooklet();
    }, 1200);
}
document.addEventListener('keydown', function (e) {
    if (e.key === "Escape") closeBooklet();
});
function closeBooklet() {
    document.getElementById('overlay').style.display = 'none';
    fetch(`https://${GetParentResourceName()}/close`, { method: 'POST' });
}
</script>
</body>
</html>
